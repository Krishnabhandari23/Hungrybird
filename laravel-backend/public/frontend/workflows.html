<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Workflows Management - CRM</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="stylesheet" href="css/style.css?v=2.1">
</head>
<body>
    <div class="app-container">
        <nav class="sidebar" id="sidebar">
            <div class="sidebar-header">
                <div class="logo">
                    <i class="fas fa-chart-network"></i>
                    <span>CRM</span>
                </div>
                <button class="hamburger" id="hamburger">
                    <span></span>
                    <span></span>
                    <span></span>
                </button>
            </div>
            <ul class="nav-menu">
                <li class="nav-item">
                    <a href="index.html" class="nav-link">
                        <i class="fas fa-home"></i>
                        <span>Dashboard</span>
                    </a>
                </li>
                <li class="nav-item">
                    <a href="leads.html" class="nav-link">
                        <i class="fas fa-fire"></i>
                        <span>Leads</span>
                    </a>
                </li>
                <li class="nav-item">
                    <a href="clients.html" class="nav-link">
                        <i class="fas fa-users"></i>
                        <span>Clients</span>
                    </a>
                </li>
                <li class="nav-item active">
                    <a href="workflows.html" class="nav-link">
                        <i class="fas fa-gear"></i>
                        <span>Workflows</span>
                    </a>
                </li>
            </ul>
        </nav>
        <main class="main-content">
            <header class="top-header">
                <div class="header-left">
                    <h1>Workflow Automation</h1>
                    <p class="text-muted">Automate your lead management process</p>
                </div>
                <div class="header-right">
                    <button class="btn btn-primary" onclick="openWorkflowModal()">
                        <i class="fas fa-plus"></i> Create Workflow
                    </button>
                </div>
            </header>
            <div class="dashboard-content">
                <section class="card">
                    <h3>Active Workflows</h3>
                    <div class="table-responsive" id="workflowsTableContainer" style="margin-top: var(--spacing-lg);">
                        <p style="text-align: center; padding: 40px; color: var(--color-text-secondary);">Loading workflows...</p>
                    </div>
                </section>

                <section class="card" style="margin-top: var(--spacing-lg);">
                    <h3>Available Triggers</h3>
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: var(--spacing-md); margin-top: var(--spacing-md);">
                        <div class="info-item">
                            <strong>lead_created</strong>
                            <p class="text-muted">When a new lead is created</p>
                        </div>
                        <div class="info-item">
                            <strong>status_updated</strong>
                            <p class="text-muted">When a lead's status changes</p>
                        </div>
                        <div class="info-item">
                            <strong>lead_converted</strong>
                            <p class="text-muted">When a lead is converted to a client</p>
                        </div>
                        <div class="info-item">
                            <strong>no_activity_7_days</strong>
                            <p class="text-muted">When a lead has no activity for 7 days</p>
                        </div>
                    </div>
                </section>

                <section class="card" style="margin-top: var(--spacing-lg);">
                    <h3>Available Actions</h3>
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: var(--spacing-md); margin-top: var(--spacing-md);">
                        <div class="info-item">
                            <strong>update_status</strong>
                            <p class="text-muted">Update lead status</p>
                        </div>
                        <div class="info-item">
                            <strong>assign_user</strong>
                            <p class="text-muted">Assign lead to a user</p>
                        </div>
                        <div class="info-item">
                            <strong>create_activity</strong>
                            <p class="text-muted">Create an activity log</p>
                        </div>
                        <div class="info-item">
                            <strong>auto_convert</strong>
                            <p class="text-muted">Automatically convert lead to client</p>
                        </div>
                        <div class="info-item">
                            <strong>send_notification</strong>
                            <p class="text-muted">Send notification (placeholder)</p>
                        </div>
                    </div>
                </section>
            </div>
        </main>
    </div>

    <!-- Workflow Modal -->
    <div id="workflowModal" class="modal">
        <div class="modal-backdrop" onclick="closeWorkflowModal()"></div>
        <div class="modal-content modal-large">
            <div class="modal-header">
                <h2 id="modalTitle">Create New Workflow</h2>
                <button class="modal-close" onclick="closeWorkflowModal()">×</button>
            </div>
            <div class="modal-body">
                <form id="workflowForm" class="form">
                    <input type="hidden" id="workflowId">
                    
                    <div class="form-group">
                        <label>Workflow Name *</label>
                        <input type="text" id="workflowName" placeholder="e.g., Auto-assign website leads" required>
                    </div>

                    <div class="form-group">
                        <label>When should this workflow run? *</label>
                        <select id="triggerEvent" required onchange="updateTriggerDescription()">
                            <option value="">-- Select a Trigger --</option>
                            <option value="lead_created">When a new lead is created</option>
                            <option value="status_updated">When lead status changes</option>
                            <option value="lead_converted">When lead converts to client</option>
                            <option value="no_activity_7_days">When lead inactive for 7 days</option>
                        </select>
                        <small id="triggerDescription" class="text-muted"></small>
                    </div>

                    <!-- Conditions Section -->
                    <div class="workflow-edit-section">
                        <div class="workflow-edit-section-header">
                            <i class="fas fa-filter"></i>
                            <h4>Conditions (Optional)</h4>
                        </div>
                        <p class="text-muted">Only run this workflow if these conditions are met:</p>
                        
                        <!-- Hidden template for cloning -->
                        <div class="condition-item" id="conditionTemplate" style="display: none;">
                            <select class="condition-field" onchange="updateConditionOperators(this)">
                                <option value="">Select Field</option>
                                <option value="status">Status</option>
                                <option value="source">Source</option>
                                <option value="email">Email</option>
                                <option value="assigned_to">Assigned To</option>
                            </select>
                            
                            <select class="condition-operator">
                                <option value="equals">equals</option>
                                <option value="not_equals">does not equal</option>
                                <option value="contains">contains</option>
                                <option value="greater_than">is greater than</option>
                                <option value="less_than">is less than</option>
                            </select>
                            
                            <input type="text" class="condition-value" placeholder="Enter value">
                            
                            <button type="button" class="btn btn-danger btn-sm" onclick="removeCondition(this)">
                                <i class="fas fa-trash"></i> Remove
                            </button>
                        </div>
                        
                        <div id="conditionsContainer" class="workflow-items-container">
                            <!-- Conditions will be added here -->
                        </div>
                        
                        <button type="button" class="btn btn-secondary" onclick="addCondition()">
                            <i class="fas fa-plus"></i> Add Condition
                        </button>
                        <small class="text-muted workflow-hint">Leave empty to run on all leads</small>
                    </div>

                    <!-- Actions Section -->
                    <div class="workflow-edit-section">
                        <div class="workflow-edit-section-header">
                            <i class="fas fa-bolt"></i>
                            <h4>Actions *</h4>
                        </div>
                        <p class="text-muted">What should happen when the workflow runs?</p>
                        
                        <div id="actionsContainer" class="workflow-items-container">
                            <!-- Actions will be added here -->
                        </div>
                        
                        <button type="button" class="btn btn-primary" onclick="addAction()">
                            <i class="fas fa-plus"></i> Add Action
                        </button>
                    </div>

                    <div class="workflow-active-section">
                        <label class="workflow-active-label">
                            <input type="checkbox" id="workflowActive" checked>
                            <span class="workflow-active-text">
                                <strong>Active</strong> <span class="text-muted">- Workflow will run automatically</span>
                            </span>
                        </label>
                    </div>

                    <div class="form-actions">
                        <button type="button" class="btn btn-secondary" onclick="closeWorkflowModal()">Cancel</button>
                        <button type="button" class="btn btn-primary" onclick="saveWorkflow()">Save Workflow</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- View Workflow Modal -->
    <div id="viewModal" class="modal">
        <div class="modal-backdrop" onclick="closeViewModal()"></div>
        <div class="modal-content modal-large">
            <div class="modal-header">
                <h2><i class="fas fa-eye"></i> View Workflow</h2>
                <button class="modal-close" onclick="closeViewModal()">×</button>
            </div>
            <div style="padding: var(--spacing-lg);" id="viewModalContent">
                <!-- Content will be populated dynamically -->
            </div>
        </div>
    </div>

    <div id="toastContainer" class="toast-container"></div>
    <script src="js/config.js"></script>
    <script src="js/dashboard.js"></script>
    <script src="js/workflows.js?v=2.0"></script>
</body>
</html>
